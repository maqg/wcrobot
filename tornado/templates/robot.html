<!DOCTYPE html>
<html>
<head>
    {% include 'head.html' %}
</head>
<body>

{% include 'header.html' %}

    <textarea title="" id="mediaType" hidden style="height: 1px">
    </textarea>


<div class="container">

    <h2 style="text-align: left">机器人列表</h2>

    <div id="errorPrompt">
    </div>

    <div style="display: inline-block">
        <label class="" style="width: 60px;float: left;line-height: 34px; margin-right: 10px">名称：</label>
        <input type="text" style="margin-right:10px; width: 200px; float: left" placeholder="请输入关键字" id="queryKeyword"
               name="keyword" value="">
        <input id="moduleQueryButton" style="margin-right:10px; width: 80px; float: left" onclick="doQuery();"
               type="button" value="刷新" class="btn btn-primary"/>
    </div>

    <table id="fileListContent" class="table table-striped">
    </table>
    <br>

    <div class="btn btn-primary" style="float: right; margin-right: 15px" onclick="addRobot();">添加机器人</div>

    {% include 'dataConfirmModal.html' %}

    {% include 'footer.html' %}

</div>


<div class="modal fade" style="top: 20%" id="modalAddRobot" tabindex="-1" role="dialog"
     aria-labelledby="modalAddRobotLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 40%">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 id="modalAddRobotTitle" class="modal-title">
                    添加镜像
                </h4>
            </div>
            <div style="margin-left: 5px; margin-right: 5px" id="modalAddRobotBody">

                <label for="robotName">名称</label><span style="color: red">*</span>
                <input id="robotName" type="text" name="robotName" title=""/>

                <label for="uId">微信ID</label><span style="color: red">*</span>
                <input id="uId" type="text" name="uId" title=""/>

            </div>
            <br>
            <div class="modal-footer">
                <button id="modalAddRobotCallback" class="btn btn-primary" style="font-size: 120%" data-dismiss="modal">
                    确定
                </button>
                <button class="btn btn-default" style="font-size: 120%" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<script>

    function getKeyword() {
        return $("#queryKeyword").val();
    }

    function doQuery() {
        var keyword = getKeyword();
        updateRobotList(keyword);
    }

    function updateRobotList(keyword) {

        json = {
            "api": "octlink.wcrobot.v1.robot.APIShowAllRobot",
            "paras": {
                "timeout": 0,
                "accountId": "",
                "sName": keyword
            },
            "session": {
                "uuid": "00000000000000000000000000000000",
                "skey": "00000000000000000000000000000000"
            },
            "async": false
        };

        bodyStr = JSON.stringify(json);

        httpPost("/api/", bodyStr, function (resJson) {

            retData = parseResponse(resJson);
            if (retData === null) {
                return;
            }

            updateFileTable(retData["robots"]);
        });
    }

    function createHeader() {

        bodyStr = "<tr><th>名称</th>";
        bodyStr += "<th>微信名</th>";
        bodyStr += "<th>微信Id</th>";
        bodyStr += "<th>联系人</th>";
        bodyStr += "<th>群组</th>";
        bodyStr += "<th>消息</th>";
        bodyStr += "<th>状态</th>";
        bodyStr += "<th>上次登录</th>";
        bodyStr += "<th>操作</th></tr>";

        return $(bodyStr);
    }

    function raiseDetail(robot) {

        $detailBody = $("#modalDetailBody");

        if ($detailBody !== null) {

            var bodyStr = "";

            fileObj = robot["files"][0];

            bodyStr += "<table class=\"table table-striped table-hover\">";
            bodyStr += "<tr><th>属性</th><th>内容</th></tr>";
            bodyStr += "<tr><td>UUID</td><td>" + robot["id"] + "</td></tr>";
            bodyStr += "<tr><td>镜像名称</td><td>" + robot["robotName"] + "</td></tr>";
            bodyStr += "<tr><td>媒体类型</td><td>" + robot["mediaType"] + "</td></tr>";

            $detailBody.html(bodyStr);

            // to modify lable
            $lable = $("#modalDetailTitle");
            if ($lable !== null) {
                $lable.html("机器人详情-" + robot["robotName"]);
            }

            $("#modalDetail").modal("show");
        } else {
            updateErrorPrompt("error", "获取详细页面错误！");
        }
    }

    function printrobot(dataObj) {

        bodyStr = "<tr><td>" + dataObj["name"] + "</td>";
        bodyStr += "<td>" + dataObj["uName"] + "</td>";
        bodyStr += "<td>" + dataObj["uId"] + "</td>";
        bodyStr += "<td>" + dataObj["contacts"] + "</td>";
        bodyStr += "<td>" + dataObj["groups"] + "</td>";
        bodyStr += "<td>" + dataObj["messages"] + "</td>";
        bodyStr += "<td>" + dataObj["stateCN"] + "</td>";
        bodyStr += "<td>" + dataObj["lastLogin"] + "</td><td>";

        bodyStr += "<button class=\"btn btn-warning detail-button\" onclick=\"funcNotFound('" + dataObj["id"] + "');\" style=\"margin-right: 10px\">编辑</button>";
        if (dataObj["state"] === 0) {
            bodyStr += "<button class=\"btn btn-info detail-button\" onclick=\"robotlogin('" + dataObj["id"] + "');\" style=\"margin-right: 10px\">登录</button>";
        } else {
            bodyStr += "<button class=\"btn btn-info detail-button\" onclick=\"robotlogut('" + dataObj["id"] + "');\" style=\"margin-right: 10px\">退出</button>";
        }
        bodyStr += "<button class=\"btn btn-primary detail-button\" onclick=\"funcNotFound('" + dataObj["id"] + "');\" style=\"margin-right: 10px\">二维码</button>";
        bodyStr += "<button class=\"btn btn-danger detail-button\" onclick=\"removerobot('" + dataObj["id"] + "');\" style=\"margin-right: 10px\" >删除</button></td></tr>";

        $tr = $(bodyStr);

        $tr.dblclick(function () {
            raiseDetail(dataObj);
        });

        return $tr;
    }

    var g_robots = {};

    function updateFileTable(fileList) {

        $fileTable = $("#fileListContent");

        $fileTable.html("");
        $fileTable.append(createHeader());

        for (var i = 0; i < fileList.length; i++) {
            dataObj = fileList[i];
            $tr = printrobot(dataObj);
            $fileTable.append($tr);
            g_robots[dataObj["id"]] = dataObj;
        }
    }

    function raiseRemoveModal(robotId, prompt) {

        $("#modalConfirmPrompt").html(prompt);

        $("#modalConfirmCallback").click(function () {
            json = {
                "api": "octlink.wcrobot.v1.robot.APIRemoveRobot",
                "paras": {
                    "timeout": 0,
                    "id": robotId,
                    "mediaType": mediaType
                },
                "session": {
                    "uuid": "00000000000000000000000000000000",
                    "skey": "00000000000000000000000000000000"
                },
                "async": false
            };

            bodyStr = JSON.stringify(json);

            httpPost("/api/", bodyStr, function (resJson) {
                parseResponse(resJson);
                $("#modalConfirm").modal("hide");
                updateRobotList(getKeyword());
            });
        });

        $("#modalConfirm").modal("show");
    }

    function removerobot(fileName) {
        raiseRemoveModal(fileName, "您确认删除此机器人吗？");
    }

    function raiseAddModal() {

        $("#modalAddRobotCallback").click(function () {

            robotName = $("#robotName").val();
            uid = $("#uId").val();
            uname = $("#uName").val();

            json = {
                "api": "octlink.wcrobot.v1.robot.APIAddRobot",
                "paras": {
                    "timeout": 0,
                    "name": robotName,
                    "uId": uid
                },
                "session": {
                    "uuid": "00000000000000000000000000000000",
                    "skey": "00000000000000000000000000000000"
                },
                "async": false
            };

            bodyStr = JSON.stringify(json);

            httpPost("/api/", bodyStr, function (resJson) {
                $("#modalAddRobot").modal("hide");
                updateRobotList(getKeyword());
            });
        });

        $("#modalAddRobot").modal("show");
    }

    function raiseUploadModal() {
        $("#modalUploadFile").modal("show");
    }

    function addRobot() {
        raiseAddModal();
    }

    doQuery();

</script>

</body>

</html>
